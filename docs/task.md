# Task: Implement Exit Strategy and Controls

- [x] Implement Exit Strategy Logic <!-- id: 61 -->
    - [x] Extend `ApiService` with `squareOffPosition` <!-- id: 62 -->
    - [x] Update `PnLService` to track Peak Profit and TSL <!-- id: 63 -->
    - [x] Implement Time-Based Exit (3:00 PM) in `PnLService` <!-- id: 64 -->
    - [x] Implement Automated Square-Off on TSL hit <!-- id: 65 -->
- [x] Update Positions Page UI <!-- id: 66 -->
    - [x] Add "Close" button for individual positions <!-- id: 67 -->
    - [x] Add "Close All" button on Positions screen <!-- id: 68 -->
- [x] Update Strategy Page UI <!-- id: 69 -->
    - [x] Display Exit Plan Cards (Responsive Grid) <!-- id: 70 -->
    - [x] Show Peak Profit and Current Trailing Stop-Loss <!-- id: 71 -->
    - [x] Ensure Tablet/Mobile compatibility <!-- id: 72 -->
- [x] Persistence for TSL state <!-- id: 73 -->
    - [x] Save/Load Peak Profit in `StorageService` <!-- id: 74 -->
- [x] Strategy Page UI Refinements <!-- id: 75 -->
    - [x] Remove strategy title <!-- id: 76 -->
    - [x] Fix time display overflow on mobile <!-- id: 77 -->
- [x] Fix Strategy Capture Logic <!-- id: 78 -->
    - [x] Relax 1:15 PM trigger condition to ">= 1:15 PM" <!-- id: 79 -->
    - [x] Ensure capture only happens once per day <!-- id: 80 -->
- [x] Troubleshoot Missing Strike Cards <!-- id: 81 -->
    - [x] Improve UI status feedback (Capturing/Resolving/Error) <!-- id: 82 -->
    - [x] Robust contract matching for PE/CE and P/C in `tsym` <!-- id: 83 -->
    - [x] Add explicit error handling/retry for capture failures <!-- id: 84 -->
- [x] Redesign Strike Selection UI <!-- id: 85 -->
    - [x] Implement side-by-side layout (PE left, CE right) <!-- id: 86 -->
    - [x] Integrate checkboxes and real-time LTP display in new layout <!-- id: 87 -->
    - [x] Ensure responsiveness for mobile/tablet <!-- id: 88 -->
- [x] Redesign & Fix Strike Selection UI <!-- id: 89 -->
    - [x] Pivot to vertical list of tall cards (full width) <!-- id: 90 -->
    - [x] Implement deep WebSocket debugging to fix LTP display <!-- id: 91 -->
    - [x] Ensure full symbol visibility without truncation <!-- id: 92 -->
    - [x] Verify real-time updates after app restart <!-- id: 93 -->
    - [x] Added manual "Resubscribe" button for troubleshooting <!-- id: 94 -->
- [x] Implement Strategy Persistence & Lock-in <!-- id: 95 -->
    - [x] Update `StorageService` to save/load daily capture data <!-- id: 96 -->
    - [x] Update `StrategyPage` to reload today's capture on init <!-- id: 97 -->
    - [x] Refine 1:15 PM trigger to respect existing daily capture <!-- id: 98 -->
    - [x] Ensure manual "Test Capture" also persists the selection <!-- id: 99 -->
- [x] Refine Dashboard & Watchlist <!-- id: 100 -->
    - [x] Remove "Quick Stats" from Dashboard <!-- id: 101 -->
    - [x] Fix search results overlay (stop hiding search box) <!-- id: 102 -->
    - [x] Add `addMultiScripsToMW` & `deleteMultiMWScrips` to `ApiService` <!-- id: 103 -->
    - [x] Sync watchlist changes with Shoonya backend <!-- id: 104 -->
    - [x] Sync watchlist changes with WebSocket subscriptions <!-- id: 105 -->
    - [x] Implement scrip delete UI in Dashboard <!-- id: 106 -->
    - [x] Ensure full symbol visibility in watchlist <!-- id: 107 -->
- [x] Refine Strategy Selection & Prices <!-- id: 108 -->
    - [x] Default unselect all resolved strikes <!-- id: 109 -->
    - [x] Fetch initial LTP during strike resolution <!-- id: 110 -->
    - [x] Debug missing LTP in Strategy Page <!-- id: 111 -->
    - [x] Fix WebSocket message type check (add `tk`) <!-- id: 112 -->
    - [x] Add verbose logging for `getQuote` and updates <!-- id: 113 -->
- [x] Refine Strategy Page UI <!-- id: 114 -->
- [x] Fix Strategy Order Placement <!-- id: 115 -->
    - [x] Correct `prdty` to `prctyp` in `ApiService.placeOrder` <!-- id: 116 -->
    - [x] Add `ordersource: 'API'` in `ApiService.placeOrder` <!-- id: 117 -->
    - [x] Update `StrategyPage._placeOrders` to use `M` (NRML) as product <!-- id: 118 -->
    - [x] Ensure correct `exch` (NFO/BFO) and `qty` are passed from `StrategyPage` <!-- id: 119 -->
    - [x] Implement robust error reporting in `StrategyPage` <!-- id: 120 -->
- [x] Implement Dynamic Order Quantity (Strike-based - Superseded) <!-- id: 121 -->
- [x] Refine Lot Size from Index Scrip <!-- id: 125 -->
    - [x] Capture `ls` from Index (NIFTY50/SENSEX) during spot capture <!-- id: 126 -->
    - [x] Store `indexLotSize` in strategy state <!-- id: 127 -->
    - [x] Update `_placeOrders` to use `userLots * indexLotSize` <!-- id: 128 -->
    - [x] Remove strike-specific `ls` logic <!-- id: 129 -->
- [x] Refine Order Book UI <!-- id: 130 -->
    - [x] Handle null `fillshares` to show `0` instead of `null` <!-- id: 131 -->
- [x] Configurable Strategy Time & Strike Deletion <!-- id: 132 -->
    - [x] Update `StorageService` to store `strategyTime` <!-- id: 133 -->
    - [x] Add time picker in `SettingsPage` <!-- id: 134 -->
    - [x] Respect `strategyTime` in `StrategyPage` trigger logic <!-- id: 135 -->
    - [x] Implement strike deletion in `StrategyPage` (UI & Logic) <!-- id: 136 -->
    - [x] Sync strike deletion with local storage <!-- id: 137 -->
- [x] Conditional Place Order Button <!-- id: 138 -->
    - [x] Hide button if no strikes are selected <!-- id: 139 -->
    - [x] Ensure button only appears after spot capture <!-- id: 140 -->
- [x] Background Strategy Service <!-- id: 141 -->
    - [x] Create `StrategyService` (singleton) <!-- id: 142 -->
    - [x] Move trigger logic (`_checkStrategyCondition`) to `StrategyService` <!-- id: 143 -->
    - [x] Move strike resolution logic to `StrategyService` <!-- id: 144 -->
    - [x] Initialize `StrategyService` in `main.dart` <!-- id: 145 -->
    - [x] Refactor `StrategyPage` to consume `StrategyService` state <!-- id: 146 -->
    - [x] Ensure TSL monitoring in `PnLService` is always active <!-- id: 147 -->
- [x] Reactive Strategy Settings <!-- id: 148 -->
    - [x] Convert `targetIndex` and `strategyTime` to `ValueNotifier` <!-- id: 149 -->
    - [x] Implement `refreshSettings` in `StrategyService` <!-- id: 150 -->
    - [x] Update `SettingsPage` to trigger refresh on save <!-- id: 151 -->
    - [x] Update `StrategyPage` UI to listen for config changes <!-- id: 152 -->
- [x] Robust Strategy Trigger <!-- id: 153 -->
    - [x] Relax time trigger to `>=` comparison <!-- id: 154 -->
    - [x] Add diagnostic logs for trigger decision tracking <!-- id: 155 -->
- [x] Fix SENSEX Resolution <!-- id: 156 -->
    - [x] Implement 100-point strike step for SENSEX <!-- id: 157 -->
    - [x] Add multi-pattern search for BSE contracts <!-- id: 158 -->
    - [x] Implement "Reset Strategy" feature <!-- id: 159 -->
    - [x] Ensure error visibility in UI after spot capture <!-- id: 160 -->
    - [x] Broaden SENSEX search and add real-time UI feedback <!-- id: 161 -->
    - [x] Hide "Test Capture" button based on settings <!-- id: 162 -->
    - [x] Remove manual refresh buttons and add Execution State indicator <!-- id: 163 -->
    - [x] Implement Quad-Strike Resolution (2 CE, 2 PE) <!-- id: 164 -->
    - [x] Redesign Strategy Status UI (Premium Gradient & Icons) <!-- id: 165 -->
    - [x] Implement Portfolio-Level Exit Strategy (Unified TSL) <!-- id: 166 -->
    - [x] Add Configurable hard stop time in Settings <!-- id: 167 -->
    - [x] Redesign Exit Plan UI (Always showing, Portfolio view) <!-- id: 168 -->
    - [x] Implement Robust Background Retry for Network Failures <!-- id: 169 -->
    - [x] Refine Strike Selection to Strictly OTM (nearest above/below) <!-- id: 170 -->
